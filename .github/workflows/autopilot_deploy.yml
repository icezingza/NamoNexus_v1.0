name: NamoNexus AutoPilot CI/CD

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master

jobs:
  autopilot:
    name: AutoPilot Deployment Pipeline
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install Dependencies
      run: |
        python3 -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio

    - name: Run Auto-Resolve Conflicts
      run: |
        python3 auto_resolve_conflicts.py || true

    - name: Run Tests
      run: |
        pytest tests --disable-warnings --maxfail=1 -q

    - name: Build Docker Image
      run: docker build -t namonexus:latest .

    - name: Setup GCP credentials
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT }}

    - name: Setup gcloud
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy namonexus-api \
          --source . \
          --platform managed \
          --region asia-southeast1 \
          --allow-unauthenticated

    - name: Auto Version Bump
      run: |
        OLD=$(cat VERSION)
        IFS='.' read -r major minor patch <<< "$OLD"
        patch=$((patch+1))
        NEW="$major.$minor.$patch"
        echo "$NEW" > VERSION

    - name: Commit Version Bump
      run: |
        git config user.name "github-actions"
        git config user.email "actions@github.com"
        git add VERSION
        git commit -m "Auto version bump"
        git push || true

    - name: Push Git Tag
      run: |
        TAG="v$(cat VERSION)"
        git tag $TAG
        git push origin $TAG || true

    - name: Generate Release Notes
      run: |
        LOG=$(git log -20 --pretty=format:'- %s (%an)')
        VERSION=$(cat VERSION)
        printf "# Release Notes for v%s\n\n## Recent Changes\n%s\n" "$VERSION" "$LOG" > RELEASE_NOTES.md

    - name: Commit Release Notes
      run: |
        git add RELEASE_NOTES.md
        git commit -m "Add autogenerated release notes"
        git push || true

    - name: Upload Deployment Summary
      uses: actions/upload-artifact@v4
      with:
        name: NamoNexus-AutoPilot-Deployment-Summary
        path: RELEASE_NOTES.md
